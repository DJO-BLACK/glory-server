<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>GLORY ‚Äì Lives</title>
  <link rel="stylesheet" href="style.css"/><link rel="manifest" href="manifest.json"/>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    .live-setup{background:rgba(212,175,55,.04);border:1px solid rgba(212,175,55,.2);border-radius:8px;padding:2rem;max-width:900px;margin:0 auto 2rem;display:none;}
    .live-setup h3{font-family:'Cinzel Decorative',cursive;color:var(--gold);font-size:1rem;margin-bottom:1.5rem;}
    .live-type-btns{display:flex;gap:.8rem;flex-wrap:wrap;margin-top:.5rem;}
    .live-type-btn{padding:.6rem 1.4rem;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:700;border:2px solid transparent;transition:all .3s;}
    .live-type-btn.video{background:rgba(229,62,62,.1);border-color:#e53e3e;color:#fc8181;}
    .live-type-btn.video.sel,.live-type-btn.video:hover{background:#e53e3e;color:#fff;}
    .live-type-btn.audio{background:rgba(212,175,55,.1);border-color:var(--gold);color:var(--gold);}
    .live-type-btn.audio.sel,.live-type-btn.audio:hover{background:var(--gold);color:var(--bg-dark);}
    .btn-start-live{margin-top:1.5rem;background:linear-gradient(135deg,var(--gold-dark),var(--gold));color:var(--bg-dark);border:none;padding:.85rem 2.5rem;font-weight:700;font-size:.9rem;letter-spacing:2px;cursor:pointer;border-radius:6px;transition:all .3s;}
    .btn-start-live:hover{filter:brightness(1.1);transform:translateY(-1px);}
    .live-main{display:none;grid-template-columns:1fr 300px;gap:1.2rem;max-width:1100px;margin:0 auto;}
    .live-main.active{display:grid;}
    .live-player-box{position:relative;background:#000;border:2px solid rgba(212,175,55,.3);border-radius:8px;aspect-ratio:16/9;overflow:hidden;display:flex;align-items:center;justify-content:center;}
    #liveVideo{width:100%;height:100%;object-fit:cover;display:none;}
    .live-placeholder-sm{text-align:center;color:var(--text-muted);padding:2rem;}
    .live-placeholder-sm .ic{font-size:3rem;opacity:.3;}
    .live-hud{position:absolute;top:0;left:0;right:0;padding:.8rem 1rem;display:flex;justify-content:space-between;align-items:flex-start;pointer-events:none;}
    .live-badge{background:red;color:#fff;font-size:.65rem;letter-spacing:2px;padding:.3rem .8rem;border-radius:3px;animation:blink 1s infinite;display:inline-block;}
    @keyframes blink{0%,100%{opacity:1;}50%{opacity:.4;}}
    .live-title-hud{background:rgba(0,0,0,.75);color:var(--gold);font-size:.88rem;padding:.35rem .8rem;border-radius:3px;font-family:'Playfair Display',serif;font-style:italic;margin-top:.4rem;}
    .hud-right{display:flex;flex-direction:column;align-items:flex-end;gap:.4rem;}
    .viewers-badge{background:rgba(0,0,0,.75);color:#fff;font-size:.78rem;padding:.3rem .7rem;border-radius:3px;}
    .viewers-badge span{color:var(--gold);font-weight:700;}
    .timer-badge{background:rgba(0,0,0,.75);color:#fff;font-size:.82rem;padding:.3rem .7rem;border-radius:3px;font-family:monospace;letter-spacing:2px;}
    .reactions-float{position:absolute;bottom:0;left:0;right:0;height:100%;pointer-events:none;overflow:hidden;}
    .float-emoji{position:absolute;bottom:-40px;font-size:1.6rem;animation:floatReact 3s ease forwards;}
    @keyframes floatReact{0%{transform:translateY(0) scale(1);opacity:1;}100%{transform:translateY(-250px) scale(1.3) translateX(var(--dx));opacity:0;}}
    #audioVisualizer{display:none;width:100%;height:90px;background:rgba(0,0,0,.6);border:1px solid rgba(212,175,55,.2);border-radius:6px;margin-top:.5rem;}
    .live-sidebar{display:flex;flex-direction:column;gap:.8rem;}
    .react-section{background:rgba(0,0,0,.3);border:1px solid rgba(212,175,55,.15);border-radius:8px;padding:.8rem;}
    .react-section-title{font-size:.68rem;letter-spacing:2px;text-transform:uppercase;color:var(--gold);margin-bottom:.6rem;}
    .react-btns{display:flex;gap:.4rem;justify-content:center;flex-wrap:wrap;}
    .react-btn{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:.5rem .9rem;font-size:1.3rem;cursor:pointer;transition:all .2s;}
    .react-btn:hover{transform:scale(1.3);}
    .react-counts{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-top:.5rem;min-height:20px;}
    .rc{font-size:.75rem;color:var(--text-muted);display:flex;align-items:center;gap:.2rem;}
    .live-cmt-box{flex:1;background:rgba(0,0,0,.4);border:1px solid rgba(212,175,55,.15);border-radius:8px;display:flex;flex-direction:column;overflow:hidden;min-height:300px;}
    .live-cmt-title{padding:.7rem 1rem;border-bottom:1px solid rgba(212,175,55,.1);font-size:.7rem;letter-spacing:2px;text-transform:uppercase;color:var(--gold);}
    .live-cmt-list{flex:1;overflow-y:auto;padding:.8rem;display:flex;flex-direction:column;gap:.5rem;}
    .live-cmt-list::-webkit-scrollbar{width:3px;}
    .live-cmt-list::-webkit-scrollbar-thumb{background:var(--gold-dark);}
    .live-cmt{display:flex;gap:.5rem;}
    .live-cmt-av{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dark),var(--gold));display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:700;color:var(--bg-dark);flex-shrink:0;}
    .live-cmt-av.adm{background:linear-gradient(135deg,#ff9800,#ffcc02);}
    .live-cmt-body{background:rgba(255,255,255,.04);border-radius:4px;padding:.4rem .7rem;flex:1;}
    .live-cmt-name{font-size:.65rem;color:var(--gold);font-weight:700;margin-bottom:.1rem;}
    .live-cmt-text{font-size:.8rem;color:var(--white);line-height:1.4;}
    .live-cmt-empty{color:rgba(184,168,122,.3);font-size:.8rem;text-align:center;margin:auto;}
    .live-cmt-input-wrap{padding:.7rem;border-top:1px solid rgba(212,175,55,.1);display:flex;gap:.5rem;}
    .live-cmt-input{flex:1;background:rgba(0,0,0,.5);border:1px solid rgba(212,175,55,.2);color:var(--white);padding:.5rem .8rem;font-size:.82rem;border-radius:4px;outline:none;font-family:'Lato',sans-serif;}
    .live-cmt-input:focus{border-color:var(--gold);}
    .live-cmt-send{background:var(--gold);color:var(--bg-dark);border:none;padding:.5rem .9rem;font-weight:700;font-size:.78rem;cursor:pointer;border-radius:4px;}
    .guest-cmt{text-align:center;padding:.7rem;font-size:.78rem;color:var(--text-muted);}
    .guest-cmt span{color:var(--gold);cursor:pointer;}
    .btn-stop-live{background:#e53e3e;color:#fff;border:none;padding:.7rem 1.8rem;font-weight:700;font-size:.85rem;cursor:pointer;border-radius:6px;display:none;margin:.8rem auto;}
    .live-schedule{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;margin-top:2rem;}
    .schedule-card{background:rgba(255,255,255,.03);border:1px solid rgba(212,175,55,.15);padding:1.2rem;border-radius:6px;}
    .schedule-date{font-size:.68rem;letter-spacing:2px;text-transform:uppercase;color:var(--gold);margin-bottom:.4rem;}
    .schedule-card h4{font-family:'Playfair Display',serif;color:var(--white);margin-bottom:.3rem;}
    .schedule-card p{color:var(--text-muted);font-size:.83rem;}
    /* Bandeau spectateur */
    .viewer-live-banner{background:rgba(229,62,62,.08);border:1px solid rgba(229,62,62,.3);border-radius:8px;padding:1.2rem 1.5rem;max-width:900px;margin:0 auto 1.5rem;display:none;align-items:center;gap:1rem;}
    .viewer-live-banner.show{display:flex;}
    .viewer-live-banner .live-badge{animation:blink 1s infinite;}
    .viewer-live-title{color:var(--gold);font-family:'Playfair Display',serif;font-size:1rem;}
    @media(max-width:768px){.live-main{grid-template-columns:1fr;}}
  </style>
</head>
<body>
<div class="page-content">
  <div class="section-wrap">
    <div class="section-header">
      <span class="section-tag">‚ú¶ En Direct ‚ú¶</span>
      <h2 class="section-title">GLORY Live</h2>
      <div class="section-line"></div>
    </div>

    <!-- Bandeau spectateur : live en cours -->
    <div class="viewer-live-banner" id="viewerBanner">
      <span class="live-badge">üî¥ EN DIRECT</span>
      <span class="viewer-live-title" id="viewerLiveTitle"></span>
      <span style="color:var(--text-muted);font-size:.82rem;margin-left:auto;">üëÅ <span id="viewerCountBanner">0</span> spectateur(s)</span>
    </div>

    <!-- Setup admin -->
    <div class="live-setup" id="liveSetup">
      <h3>‚öô Configurer ton Live</h3>
      <div class="form-group" style="margin-bottom:1.2rem;">
        <label>Titre du live</label>
        <input type="text" id="liveTitle" placeholder="Ex: Culte du Dimanche, Soir√©e de Pri√®re..."/>
      </div>
      <div class="form-group">
        <label>Type de live</label>
        <div class="live-type-btns">
          <button class="live-type-btn video sel" id="btnTypeVideo" onclick="selectType('video')">üé• Vid√©o + Audio</button>
          <button class="live-type-btn audio" id="btnTypeAudio" onclick="selectType('audio')">üéô Audio seulement</button>
        </div>
      </div>
      <button class="btn-start-live" onclick="doStartLive()">üî¥ Lancer le Live</button>
    </div>

    <!-- Live principal -->
    <div class="live-main" id="liveMain">
      <div>
        <div class="live-player-box" id="liveBox">
          <video id="liveVideo" autoplay muted playsinline></video>
          <div class="live-placeholder-sm" id="livePlaceholder"><div class="ic">üéô</div><p>Live audio en cours</p></div>
          <div class="live-hud">
            <div>
              <span class="live-badge">üî¥ EN DIRECT</span>
              <div class="live-title-hud" id="liveTitleHud"></div>
            </div>
            <div class="hud-right">
              <div class="viewers-badge">üëÅ <span id="viewersCount">0</span> spectateur(s)</div>
              <div class="timer-badge" id="timerDisplay">00:00:00</div>
            </div>
          </div>
          <div class="reactions-float" id="reactionsFloat"></div>
        </div>
        <canvas id="audioVisualizer"></canvas>
        <div style="text-align:center;"><button class="btn-stop-live" id="btnStopLive" onclick="doStopLive()">‚èπ Arr√™ter le Live</button></div>
      </div>
      <div class="live-sidebar">
        <div class="react-section">
          <div class="react-section-title">R√©agir au live</div>
          <div class="react-btns">
            <button class="react-btn" onclick="sendReaction('üëç')">üëç</button>
            <button class="react-btn" onclick="sendReaction('üß°')">üß°</button>
            <button class="react-btn" onclick="sendReaction('üî•')">üî•</button>
            <button class="react-btn" onclick="sendReaction('üôè')">üôè</button>
            <button class="react-btn" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
            <button class="react-btn" onclick="sendReaction('üéâ')">üéâ</button>
          </div>
          <div class="react-counts" id="reactCounts"></div>
        </div>
        <div class="live-cmt-box">
          <div class="live-cmt-title">üí¨ Commentaires du Live</div>
          <div class="live-cmt-list" id="liveCommentsList"><div class="live-cmt-empty">Les commentaires appara√Ætront ici...</div></div>
          <div class="live-cmt-input-wrap">
            <div id="liveCmtInputArea" style="display:none;flex:1;">
              <div style="display:flex;gap:.5rem;width:100%;">
                <input class="live-cmt-input" type="text" id="liveCmtInput" placeholder="Commente..." onkeydown="if(event.key==='Enter')sendLiveComment()"/>
                <button class="live-cmt-send" onclick="sendLiveComment()">‚Üë</button>
              </div>
            </div>
            <div class="guest-cmt" id="liveCmtGuest"><span onclick="openModal('login')">Connecte-toi</span> pour commenter</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Prochains lives -->
    <div id="scheduleSection">
      <h3 style="font-family:'Playfair Display',serif;color:var(--gold);margin:2rem 0 1.2rem;font-size:1.2rem;">üìÖ Prochains Lives</h3>
      <div class="live-schedule">
        <div class="schedule-card"><div class="schedule-date">Dimanche ‚Äì 10h00</div><h4>Culte du Dimanche</h4><p>Service d'adoration et pr√©dication</p></div>
        <div class="schedule-card"><div class="schedule-date">Mercredi ‚Äì 21h00</div><h4>Soir√©e de Pri√®re</h4><p>Intercession pour la communaut√© mondiale</p></div>
        <div class="schedule-card"><div class="schedule-date">Vendredi ‚Äì 20h00</div><h4>Worship Night</h4><p>Session d'adoration musicale et louange</p></div>
      </div>
    </div>
  </div>
</div>

<script src="components.js"></script><script src="auth.js"></script><script src="glory-api.js"></script><script src="i18n.js"></script><script src="notifications.js"></script>
<script>
// ===== SOCKET.IO =====
const socket = initSocket();

let liveStream=null,audioCtx=null,animFrame=null,liveType='video',timerInt=null,startTime=null;
let reactionCounts={'üëç':0,'üß°':0,'üî•':0,'üôè':0,'‚ù§Ô∏è':0,'üéâ':0};

function selectType(t){
  liveType=t;
  document.getElementById('btnTypeVideo').classList.toggle('sel',t==='video');
  document.getElementById('btnTypeAudio').classList.toggle('sel',t==='audio');
}

// ===== ADMIN : D√âMARRER LE LIVE =====
async function doStartLive(){
  const title=document.getElementById('liveTitle').value.trim();
  if(!title){toast('‚ö† Donne un titre √† ton live.');return;}
  try {
    await startLive(title, liveType); // glory-api.js

    liveStream=await navigator.mediaDevices.getUserMedia(liveType==='video'?{video:true,audio:true}:{audio:true,video:false});

    document.getElementById('liveSetup').style.display='none';
    document.getElementById('scheduleSection').style.display='none';
    document.getElementById('liveMain').classList.add('active');
    document.getElementById('btnStopLive').style.display='inline-block';
    document.getElementById('liveTitleHud').textContent=title;

    if(liveType==='video'){
      const v=document.getElementById('liveVideo');v.srcObject=liveStream;v.style.display='block';
      document.getElementById('livePlaceholder').style.display='none';
    } else {
      document.getElementById('livePlaceholder').style.display='flex';
      startAudioViz(liveStream);
    }

    startTime=Date.now();
    timerInt=setInterval(updateTimer,1000);

    const user=GloryAuth.getUser();
    if(user) socket.emit('join-live', user.email);

    updateLiveCmtUI();
    toast('üî¥ Live "'+title+'" d√©marr√© !');
  } catch(e) {
    toast('‚ùå '+e.message);
  }
}

// ===== ADMIN : ARR√äTER LE LIVE =====
async function doStopLive(){
  try { await stopLive(); } catch(e){} // glory-api.js

  if(liveStream){liveStream.getTracks().forEach(t=>t.stop());liveStream=null;}
  if(audioCtx){audioCtx.close();audioCtx=null;}
  if(animFrame){cancelAnimationFrame(animFrame);animFrame=null;}
  if(timerInt){clearInterval(timerInt);timerInt=null;}

  const user=GloryAuth.getUser();
  if(user) socket.emit('leave-live', user.email);

  startTime=null;
  reactionCounts={'üëç':0,'üß°':0,'üî•':0,'üôè':0,'‚ù§Ô∏è':0,'üéâ':0};

  document.getElementById('liveVideo').style.display='none';
  document.getElementById('liveVideo').srcObject=null;
  document.getElementById('livePlaceholder').style.display='flex';
  document.getElementById('audioVisualizer').style.display='none';
  document.getElementById('liveMain').classList.remove('active');
  document.getElementById('btnStopLive').style.display='none';
  document.getElementById('liveSetup').style.display='block';
  document.getElementById('scheduleSection').style.display='block';
  document.getElementById('liveTitle').value='';
  document.getElementById('timerDisplay').textContent='00:00:00';
  document.getElementById('viewersCount').textContent='0';
  document.getElementById('reactCounts').innerHTML='';
  document.getElementById('liveCommentsList').innerHTML='<div class="live-cmt-empty">Les commentaires appara√Ætront ici...</div>';
  toast('‚èπ Live arr√™t√©.');
}

function updateTimer(){
  if(!startTime)return;
  const el=Math.floor((Date.now()-startTime)/1000);
  const h=String(Math.floor(el/3600)).padStart(2,'0'),m=String(Math.floor((el%3600)/60)).padStart(2,'0'),s=String(el%60).padStart(2,'0');
  document.getElementById('timerDisplay').textContent=h+':'+m+':'+s;
}

function startAudioViz(stream){
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  const src=audioCtx.createMediaStreamSource(stream),an=audioCtx.createAnalyser();
  an.fftSize=256;src.connect(an);
  const cv=document.getElementById('audioVisualizer');cv.style.display='block';
  const c=cv.getContext('2d'),buf=an.frequencyBinCount,d=new Uint8Array(buf);
  function resize(){cv.width=cv.offsetWidth||500;cv.height=90;}resize();
  window.addEventListener('resize',resize);
  function draw(){
    animFrame=requestAnimationFrame(draw);an.getByteFrequencyData(d);
    c.clearRect(0,0,cv.width,cv.height);c.fillStyle='rgba(10,8,0,.8)';c.fillRect(0,0,cv.width,cv.height);
    const bw=(cv.width/buf)*2.2;
    for(let i=0;i<buf;i++){const bh=(d[i]/255)*cv.height;c.fillStyle=`hsl(${42+d[i]/255*18},85%,${38+d[i]/255*28}%)`;c.fillRect(i*bw*1.1,cv.height-bh,bw,bh);}
  }draw();
}

// ===== R√âACTIONS =====
function sendReaction(emoji){
  const user=GloryAuth.getUser();if(!user){openModal('login');return;}
  socket.emit('live-reaction',{emoji, name:user.name});
  spawnEmoji(emoji);
}
function spawnEmoji(emoji){
  const c=document.getElementById('reactionsFloat'),el=document.createElement('div');
  el.className='float-emoji';el.textContent=emoji;
  const dx=(Math.random()-.5)*60+'px';
  el.style.cssText=`left:${10+Math.random()*80}%;--dx:${dx}`;
  c.appendChild(el);setTimeout(()=>el.remove(),3100);
}
function updateReactCounts(){
  document.getElementById('reactCounts').innerHTML=Object.entries(reactionCounts).filter(([,v])=>v>0).map(([k,v])=>`<div class="rc">${k} <strong style="color:var(--white)">${v}</strong></div>`).join('');
}

// ===== COMMENTAIRES =====
function sendLiveComment(){
  const user=GloryAuth.getUser();if(!user)return;
  const input=document.getElementById('liveCmtInput');
  const text=input.value.trim();if(!text)return;
  socket.emit('live-comment',{name:user.name,role:user.role,text,time:new Date().toLocaleTimeString('fr',{hour:'2-digit',minute:'2-digit'})});
  input.value='';
}

function addComment(c){
  const list=document.getElementById('liveCommentsList');
  const empty=list.querySelector('.live-cmt-empty');if(empty)empty.remove();
  const ini=c.name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
  const d=document.createElement('div');d.className='live-cmt';
  d.innerHTML=`<div class="live-cmt-av ${c.role==='admin'?'adm':''}">${ini}</div><div class="live-cmt-body"><div class="live-cmt-name">${c.role==='admin'?'‚ú¶ ':''}${c.name}</div><div class="live-cmt-text">${c.text}</div></div>`;
  list.appendChild(d);list.scrollTop=list.scrollHeight;
}

function updateLiveCmtUI(){
  const user=GloryAuth.getUser();
  const ia=document.getElementById('liveCmtInputArea'),g=document.getElementById('liveCmtGuest');
  if(user){ia.style.display='flex';if(g)g.style.display='none';}
  else{ia.style.display='none';if(g)g.style.display='block';}
}

// ===== SOCKET EVENTS =====
socket.on('viewers-count', count => {
  document.getElementById('viewersCount').textContent=count;
  document.getElementById('viewerCountBanner').textContent=count;
});

socket.on('live-reaction', data => {
  reactionCounts[data.emoji]=(reactionCounts[data.emoji]||0)+1;
  updateReactCounts();
  spawnEmoji(data.emoji);
});

socket.on('live-comment', data => {
  addComment(data);
});

// Quand un live d√©marre (pour les spectateurs)
socket.on('live-started', live => {
  document.getElementById('viewerBanner').classList.add('show');
  document.getElementById('viewerLiveTitle').textContent=live.title;
  document.getElementById('liveMain').classList.add('active');
  document.getElementById('liveTitleHud').textContent=live.title;
  document.getElementById('scheduleSection').style.display='none';
  updateLiveCmtUI();
  // Rejoindre le live
  const user=getSession();
  if(user) socket.emit('join-live', user.email);
  toast('üî¥ Live d√©marr√© : '+live.title);
});

// Quand le live s'arr√™te (pour les spectateurs)
socket.on('live-stopped', () => {
  document.getElementById('viewerBanner').classList.remove('show');
  document.getElementById('liveMain').classList.remove('active');
  document.getElementById('scheduleSection').style.display='block';
  document.getElementById('liveCommentsList').innerHTML='<div class="live-cmt-empty">Les commentaires appara√Ætront ici...</div>';
  document.getElementById('reactCounts').innerHTML='';
  reactionCounts={'üëç':0,'üß°':0,'üî•':0,'üôè':0,'‚ù§Ô∏è':0,'üéâ':0};
  toast('‚èπ Le live est termin√©.');
});

// ===== INIT =====
window.addEventListener('DOMContentLoaded', async () => {
  const user=GloryAuth.getUser();
  const isAdmin=GloryAuth.isAdmin();

  if(isAdmin) document.getElementById('liveSetup').style.display='block';
  updateLiveCmtUI();

  // V√©rifier si un live est d√©j√† en cours
  if(GloryAuth.isLoggedIn()){
    try {
      const live=await getLiveStatus();
      if(live){
        document.getElementById('viewerBanner').classList.add('show');
        document.getElementById('viewerLiveTitle').textContent=live.title;
        if(!isAdmin){
          document.getElementById('liveMain').classList.add('active');
          document.getElementById('liveTitleHud').textContent=live.title;
          document.getElementById('scheduleSection').style.display='none';
          socket.emit('join-live', user?.email||'anonymous');
        }
      }
    } catch(e){}
  }
});

window.addEventListener('beforeunload',()=>{
  const user=GloryAuth.getUser();
  if(user) socket.emit('leave-live', user.email);
});
</script>
</body></html>
