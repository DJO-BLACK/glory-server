<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>GLORY ‚Äì Lives</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="manifest" href="manifest.json"/>
  <style>
    .live-setup{background:rgba(212,175,55,.04);border:1px solid rgba(212,175,55,.2);border-radius:8px;padding:2rem;max-width:700px;margin:0 auto 2rem;display:none;}
    .live-setup h3{font-family:'Cinzel Decorative',cursive;color:var(--gold);font-size:1rem;margin-bottom:1.5rem;}
    .btn-start-live{margin-top:1.5rem;background:linear-gradient(135deg,#c53030,#e53e3e);color:#fff;border:none;padding:.85rem 2.5rem;font-weight:700;font-size:.9rem;letter-spacing:2px;cursor:pointer;border-radius:6px;transition:all .3s;width:100%;}
    .btn-start-live:hover{filter:brightness(1.1);}
    .btn-stop-live{background:#e53e3e;color:#fff;border:none;padding:.7rem 2rem;font-weight:700;font-size:.85rem;cursor:pointer;border-radius:6px;margin:1rem auto;display:block;}
    .live-container{display:none;max-width:1100px;margin:0 auto;}
    .live-container.active{display:block;}
    .live-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem;}
    .live-badge{background:red;color:#fff;font-size:.65rem;letter-spacing:2px;padding:.3rem .8rem;border-radius:3px;animation:blink 1s infinite;}
    @keyframes blink{0%,100%{opacity:1;}50%{opacity:.4;}}
    .live-title-text{font-family:'Playfair Display',serif;color:var(--gold);font-size:1.1rem;font-style:italic;}
    .viewers-count{background:rgba(0,0,0,.5);color:#fff;font-size:.78rem;padding:.3rem .8rem;border-radius:20px;}
    #jitsiContainer{width:100%;height:600px;border-radius:8px;overflow:hidden;border:2px solid rgba(212,175,55,.3);background:#000;}
    .no-live-box{text-align:center;padding:4rem 2rem;background:rgba(255,255,255,.02);border:1px solid rgba(212,175,55,.12);border-radius:8px;max-width:600px;margin:0 auto;}
    .no-live-box .ic{font-size:3rem;margin-bottom:1rem;opacity:.4;}
    .live-schedule{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;margin-top:2rem;}
    .schedule-card{background:rgba(255,255,255,.03);border:1px solid rgba(212,175,55,.15);padding:1.2rem;border-radius:6px;}
    .schedule-date{font-size:.68rem;letter-spacing:2px;text-transform:uppercase;color:var(--gold);margin-bottom:.4rem;}
    .schedule-card h4{font-family:'Playfair Display',serif;color:var(--white);margin-bottom:.3rem;}
    .schedule-card p{color:var(--text-muted);font-size:.83rem;}
    .join-btn{margin-top:1.5rem;background:linear-gradient(135deg,var(--gold-dark),var(--gold));color:var(--bg-dark);border:none;padding:.85rem 2.5rem;font-weight:700;font-size:.9rem;letter-spacing:2px;cursor:pointer;border-radius:6px;display:none;}
    @media(max-width:768px){#jitsiContainer{height:400px;}}
  </style>
</head>
<body>
<div class="page-content">
  <div class="section-wrap">
    <div class="section-header">
      <span class="section-tag">‚ú¶ En Direct ‚ú¶</span>
      <h2 class="section-title">GLORY Live</h2>
      <div class="section-line"></div>
    </div>

    <!-- Setup admin -->
    <div class="live-setup admin-only" id="liveSetup">
      <h3>üî¥ D√©marrer un Live</h3>
      <div class="form-group">
        <label>Titre du live</label>
        <input type="text" id="liveTitle" placeholder="Ex: Culte du Dimanche, Soir√©e de Pri√®re..."/>
      </div>
      <button class="btn-start-live" onclick="startLive()">üî¥ Lancer le Live</button>
    </div>

    <!-- Pas de live -->
    <div id="noLiveBox" class="no-live-box">
      <div class="ic">üì°</div>
      <p style="color:var(--white);font-size:1rem;margin-bottom:.5rem;">Aucun live en cours</p>
      <p style="color:var(--text-muted);font-size:.85rem;">L'admin d√©marrera bient√¥t un live. Tu seras notifi√© automatiquement !</p>
      <button class="join-btn" id="joinBtn" onclick="joinLive()">üé• Rejoindre le Live</button>
    </div>

    <!-- Live en cours -->
    <div class="live-container" id="liveContainer">
      <div class="live-header">
        <span class="live-badge">üî¥ EN DIRECT</span>
        <span class="live-title-text" id="liveTitleDisplay"></span>
        <span class="viewers-count">üëÅ <span id="viewerCount">0</span> participant(s)</span>
      </div>
      <div id="jitsiContainer"></div>
      <button class="btn-stop-live admin-only" id="btnStop" onclick="stopLive()" style="display:none;">‚èπ Terminer le Live</button>
    </div>

    <!-- Programme -->
    <div id="scheduleSection" style="margin-top:3rem;">
      <h3 style="font-family:'Playfair Display',serif;color:var(--gold);margin-bottom:1.2rem;font-size:1.2rem;">üìÖ Programme des Lives</h3>
      <div class="live-schedule">
        <div class="schedule-card"><div class="schedule-date">Dimanche ‚Äì 10h00</div><h4>Culte du Dimanche</h4><p>Service d'adoration et pr√©dication</p></div>
        <div class="schedule-card"><div class="schedule-date">Mercredi ‚Äì 21h00</div><h4>Soir√©e de Pri√®re</h4><p>Intercession pour la communaut√© mondiale</p></div>
        <div class="schedule-card"><div class="schedule-date">Vendredi ‚Äì 20h00</div><h4>Worship Night</h4><p>Adoration musicale et louange</p></div>
      </div>
    </div>
  </div>
</div>

<script src="https://glory-server-production.up.railway.app/socket.io/socket.io.js"></script>
<script src="components.js"></script>
<script src="api.js"></script>
<script src="i18n.js"></script>
<script src="notifications.js"></script>
<script>
const SERVER_URL = 'https://glory-server-production.up.railway.app';
const socket = io(SERVER_URL, { transports: ['websocket','polling'] });

let jitsiApi = null;
let currentRoomName = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äî D√©marrer le live
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startLive() {
  const title = document.getElementById('liveTitle').value.trim();
  if (!title) { toast('‚ö† Donne un titre √† ton live.'); return; }
  const user = getSession();
  if (!user) { openModal('login'); return; }

  // Cr√©er un nom de salle unique bas√© sur la date
  const roomName = 'GLORY-' + Date.now();

  // Notifier tous les membres via Socket.io
  socket.emit('start_live', { title, roomName, userName: user.name });

  // Lancer Jitsi pour l'admin
  launchJitsi(roomName, user.name, true, title);
  createNotif('live', 'üî¥ Live : ' + title, 'Rejoins le live GLORY maintenant !', 'lives.html');
  toast('üî¥ Live d√©marr√© ! Les membres peuvent maintenant rejoindre.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEMBRE ‚Äî Rejoindre le live
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function joinLive() {
  const user = getSession();
  if (!user) { openModal('login'); return; }
  if (currentRoomName) {
    launchJitsi(currentRoomName, user.name, false);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Lancer Jitsi Meet
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function launchJitsi(roomName, displayName, isHost, title) {
  // Charger le script Jitsi si pas encore charg√©
  if (!window.JitsiMeetExternalAPI) {
    const script = document.createElement('script');
    script.src = 'https://meet.jit.si/external_api.js';
    script.onload = () => initJitsi(roomName, displayName, isHost, title);
    document.head.appendChild(script);
  } else {
    initJitsi(roomName, displayName, isHost, title);
  }
}

function initJitsi(roomName, displayName, isHost, title) {
  // Afficher le container
  document.getElementById('noLiveBox').style.display = 'none';
  document.getElementById('scheduleSection').style.display = 'none';
  document.getElementById('liveContainer').classList.add('active');
  document.getElementById('liveTitleDisplay').textContent = title || currentRoomName;
  if (isHost) {
    document.getElementById('liveSetup').style.display = 'none';
    document.getElementById('btnStop').style.display = 'block';
  }

  // Nettoyer l'ancien Jitsi si existe
  if (jitsiApi) { jitsiApi.dispose(); jitsiApi = null; }
  document.getElementById('jitsiContainer').innerHTML = '';

  const options = {
    roomName: roomName,
    parentNode: document.getElementById('jitsiContainer'),
    userInfo: { displayName: displayName },
    configOverwrite: {
      startWithAudioMuted: false,
      startWithVideoMuted: false,
      enableWelcomePage: false,
      prejoinPageEnabled: false,
      disableDeepLinking: true,
      defaultLanguage: 'fr',
      toolbarButtons: ['microphone','camera','desktop','chat','raisehand','tileview','hangup']
    },
    interfaceConfigOverwrite: {
      SHOW_JITSI_WATERMARK: false,
      SHOW_WATERMARK_FOR_GUESTS: false,
      TOOLBAR_ALWAYS_VISIBLE: true,
      DEFAULT_BACKGROUND: '#0a0800',
      BRAND_WATERMARK_LINK: '',
      APP_NAME: 'GLORY Live',
      NATIVE_APP_NAME: 'GLORY Live',
      PROVIDER_NAME: 'GLORY',
    }
  };

  jitsiApi = new window.JitsiMeetExternalAPI('meet.jit.si', options);

  // Compter les participants
  jitsiApi.addEventListeners({
    participantJoined: () => updateViewerCount(),
    participantLeft: () => updateViewerCount(),
    videoConferenceLeft: () => {
      if (!isHost) leaveLive();
    }
  });
}

function updateViewerCount() {
  if (jitsiApi) {
    const count = jitsiApi.getNumberOfParticipants();
    document.getElementById('viewerCount').textContent = count;
    socket.emit('update_viewer_count', count);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äî Arr√™ter le live
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function stopLive() {
  if (jitsiApi) { jitsiApi.dispose(); jitsiApi = null; }
  socket.emit('stop_live');
  document.getElementById('liveContainer').classList.remove('active');
  document.getElementById('noLiveBox').style.display = 'block';
  document.getElementById('scheduleSection').style.display = 'block';
  document.getElementById('btnStop').style.display = 'none';
  document.getElementById('liveSetup').style.display = 'block';
  document.getElementById('liveTitle').value = '';
  currentRoomName = null;
  toast('‚èπ Live termin√©.');
}

function leaveLive() {
  if (jitsiApi) { jitsiApi.dispose(); jitsiApi = null; }
  document.getElementById('liveContainer').classList.remove('active');
  document.getElementById('noLiveBox').style.display = 'block';
  document.getElementById('scheduleSection').style.display = 'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SOCKET.IO ‚Äî √âv√©nements
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
socket.on('live_started', ({ title, roomName }) => {
  currentRoomName = roomName;
  document.getElementById('noLiveBox').style.display = 'block';
  document.getElementById('joinBtn').style.display = 'inline-block';
  document.getElementById('joinBtn').textContent = 'üé• Rejoindre : ' + title;
  createNotif('live', 'üî¥ Live en cours : ' + title, 'Clique pour rejoindre !', 'lives.html');
  toast('üî¥ Un live a d√©marr√© : ' + title + ' ‚Äî Clique pour rejoindre !');
});

socket.on('live_ended', () => {
  currentRoomName = null;
  if (jitsiApi) { jitsiApi.dispose(); jitsiApi = null; }
  document.getElementById('liveContainer').classList.remove('active');
  document.getElementById('noLiveBox').style.display = 'block';
  document.getElementById('joinBtn').style.display = 'none';
  document.getElementById('scheduleSection').style.display = 'block';
  toast('‚èπ Le live est termin√©.');
});

socket.on('viewer_count', count => {
  document.getElementById('viewerCount').textContent = count;
});

socket.on('live_info', ({ title, roomName }) => {
  currentRoomName = roomName;
  document.getElementById('joinBtn').style.display = 'inline-block';
  document.getElementById('joinBtn').textContent = 'üé• Rejoindre : ' + title;
});

socket.on('no_live', () => {
  document.getElementById('joinBtn').style.display = 'none';
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', () => {
  const user = getSession();
  if (user && (user.role === 'admin' || user.role === 'subadmin')) {
    document.getElementById('liveSetup').style.display = 'block';
  }
  socket.on('connect', () => socket.emit('check_live'));
  if (socket.connected) socket.emit('check_live');
});
</script>
</body>
</html>
