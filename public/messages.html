<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>GLORY ‚Äì Messages</title>
  <link rel="stylesheet" href="style.css"/><link rel="manifest" href="manifest.json"/>
  <style>
    .msg-layout{display:grid;grid-template-columns:240px 1fr;gap:1.2rem;max-width:1100px;margin:0 auto;}
    .msg-sidebar{display:flex;flex-direction:column;gap:.8rem;}
    .conv-tabs{display:flex;border:1px solid rgba(212,175,55,.2);border-radius:6px;overflow:hidden;}
    .conv-tab{flex:1;background:none;border:none;color:var(--text-muted);padding:.6rem .4rem;font-size:.68rem;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all .3s;}
    .conv-tab.active{background:var(--gold);color:var(--bg-dark);font-weight:700;}
    .conv-tab:hover:not(.active){background:rgba(212,175,55,.1);color:var(--gold);}
    .sidebar-label{font-size:.6rem;letter-spacing:3px;text-transform:uppercase;color:var(--gold);padding:.3rem 0;border-bottom:1px solid rgba(212,175,55,.1);}
    .user-list{display:flex;flex-direction:column;gap:.3rem;overflow-y:auto;max-height:55vh;}
    .user-list::-webkit-scrollbar{width:3px;}
    .user-list::-webkit-scrollbar-thumb{background:var(--gold-dark);}
    .user-item{display:flex;align-items:center;gap:.6rem;padding:.5rem .7rem;border-radius:6px;background:rgba(255,255,255,.02);border:1px solid rgba(212,175,55,.07);}
    .u-av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;color:var(--bg-dark);flex-shrink:0;}
    .u-av.adm{background:linear-gradient(135deg,#ff9800,#ffcc02);}
    .u-av.mem{background:linear-gradient(135deg,var(--gold-dark),var(--gold));}
    .u-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
    .u-name{font-size:.78rem;color:var(--white);}
    .u-country{font-size:.63rem;color:rgba(184,168,122,.4);}
    .u-role{font-size:.58rem;color:var(--gold);letter-spacing:1px;text-transform:uppercase;}
    .msg-main{display:flex;flex-direction:column;border-radius:8px;overflow:hidden;border:1px solid rgba(212,175,55,.15);min-height:600px;}
    .conv-header{background:rgba(212,175,55,.05);padding:.8rem 1.2rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(212,175,55,.1);}
    .conv-header-title{font-family:'Playfair Display',serif;color:var(--gold);font-size:1rem;}
    .conv-header-sub{font-size:.7rem;color:var(--text-muted);}
    .lock-badge{font-size:.6rem;background:rgba(212,175,55,.1);border:1px solid rgba(212,175,55,.2);color:var(--gold);padding:.2rem .6rem;border-radius:2px;letter-spacing:1px;}
    .msg-list{flex:1;background:rgba(0,0,0,.3);overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.6rem;min-height:400px;max-height:50vh;}
    .msg-list::-webkit-scrollbar{width:4px;}
    .msg-list::-webkit-scrollbar-thumb{background:var(--gold-dark);border-radius:2px;}
    .msg-empty{margin:auto;text-align:center;color:rgba(184,168,122,.3);font-size:.85rem;}
    .msg-row{display:flex;gap:.5rem;align-items:flex-end;}
    .msg-row.me{flex-direction:row-reverse;}
    .m-av{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;color:var(--bg-dark);flex-shrink:0;overflow:hidden;}
    .m-av.adm{background:linear-gradient(135deg,#ff9800,#ffcc02);}
    .m-av.mem{background:linear-gradient(135deg,var(--gold-dark),var(--gold));}
    .m-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
    .msg-bwrap{max-width:66%;}
    .msg-sender{font-size:.62rem;letter-spacing:1px;text-transform:uppercase;color:var(--gold);margin-bottom:.2rem;}
    .msg-row.me .msg-sender{text-align:right;color:var(--text-muted);}
    .msg-sender.adm-lbl{color:#ff9800;}
    .msg-bubble{padding:.6rem .9rem;border-radius:6px;font-size:.87rem;line-height:1.5;word-break:break-word;position:relative;}
    .msg-bubble.from-adm{background:rgba(255,152,0,.1);border-left:3px solid #ff9800;color:var(--white);}
    .msg-bubble.from-mem{background:rgba(255,255,255,.05);border:1px solid rgba(212,175,55,.12);color:var(--white);}
    .msg-bubble.mine{background:rgba(212,175,55,.18);border-right:3px solid var(--gold);}
    .react-popup{display:none;position:absolute;bottom:calc(100% + 6px);background:rgba(20,16,4,.97);border:1px solid rgba(212,175,55,.3);border-radius:8px;padding:.4rem .6rem;gap:.3rem;z-index:100;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,.5);}
    .react-popup.show{display:flex;}
    .react-popup button{background:none;border:none;font-size:1.2rem;cursor:pointer;padding:.2rem;border-radius:4px;transition:transform .15s;}
    .react-popup button:hover{transform:scale(1.3);}
    .msg-meta-row{display:flex;align-items:center;gap:.4rem;margin-top:.25rem;flex-wrap:wrap;}
    .msg-time{font-size:.6rem;color:rgba(184,168,122,.3);}
    .react-trigger{background:none;border:none;font-size:.72rem;color:rgba(184,168,122,.35);cursor:pointer;padding:.1rem .3rem;border-radius:3px;transition:all .2s;}
    .react-trigger:hover{color:var(--gold);background:rgba(212,175,55,.1);}
    .react-pills{display:flex;gap:.25rem;flex-wrap:wrap;}
    .react-pill{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:.12rem .45rem;font-size:.75rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:.15rem;}
    .react-pill:hover{background:rgba(255,255,255,.1);transform:scale(1.05);}
    .react-pill.mine-pill{background:rgba(212,175,55,.18);border-color:rgba(212,175,55,.4);}
    .react-pill .rc{font-size:.65rem;color:var(--text-muted);}
    .audio-msg{display:flex;align-items:center;gap:.6rem;padding:.3rem 0;}
    .play-btn{background:var(--gold);border:none;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.8rem;flex-shrink:0;transition:all .2s;}
    .play-btn:hover{background:var(--gold-light);}
    .audio-wave{flex:1;height:28px;background:rgba(212,175,55,.07);border-radius:4px;overflow:hidden;position:relative;}
    .audio-wave-bar{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,rgba(212,175,55,.35),rgba(212,175,55,.12));border-radius:4px;transition:width .1s;}
    .audio-dur{font-size:.72rem;color:var(--text-muted);flex-shrink:0;}
    .msg-input-wrap{background:rgba(0,0,0,.3);border-top:1px solid rgba(212,175,55,.1);padding:.8rem 1rem;}
    .rec-indicator{display:none;align-items:center;gap:.6rem;padding:.4rem .8rem;background:rgba(229,62,62,.08);border:1px solid rgba(229,62,62,.2);border-radius:6px;margin-bottom:.5rem;}
    .rec-indicator.active{display:flex;}
    .rec-dot{width:8px;height:8px;border-radius:50%;background:#e53e3e;animation:blink 1s infinite;}
    @keyframes blink{0%,100%{opacity:1;}50%{opacity:.3;}}
    .rec-text{font-size:.8rem;color:#fc8181;}
    .rec-timer{font-size:.8rem;color:#fc8181;font-family:monospace;}
    .msg-input-row{display:flex;gap:.6rem;align-items:center;}
    .msg-input{flex:1;background:rgba(0,0,0,.5);border:1px solid rgba(212,175,55,.2);color:var(--white);padding:.65rem 1rem;font-family:'Lato',sans-serif;font-size:.87rem;border-radius:6px;outline:none;transition:border-color .3s;}
    .msg-input:focus{border-color:var(--gold);}
    .voice-btn{background:rgba(212,175,55,.1);border:1px solid rgba(212,175,55,.3);color:var(--gold);width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:all .3s;flex-shrink:0;}
    .voice-btn:hover{background:var(--gold);color:var(--bg-dark);}
    .voice-btn.recording{background:#e53e3e;border-color:#e53e3e;color:#fff;animation:pulse 1s infinite;}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(229,62,62,.4);}50%{box-shadow:0 0 0 8px rgba(229,62,62,0);}}
    .msg-send{background:var(--gold);color:var(--bg-dark);border:none;padding:.65rem 1.2rem;font-weight:700;cursor:pointer;border-radius:6px;transition:all .3s;font-size:.85rem;}
    .msg-send:hover{background:var(--gold-light);}
    .locked-notice{text-align:center;padding:1.2rem;color:var(--text-muted);}
    .login-notice{text-align:center;padding:1rem;color:var(--text-muted);font-size:.85rem;}
    .login-notice span{color:var(--gold);cursor:pointer;}
    @media(max-width:768px){.msg-layout{grid-template-columns:1fr;}.msg-sidebar{display:none;}}
  </style>
</head>
<body>
<div class="page-content">
  <div class="section-wrap">
    <div class="section-header">
      <span class="section-tag" data-i18n="msg_tag">‚ú¶ Communaut√© ‚ú¶</span>
      <h2 class="section-title" data-i18n="msg_title">Espace Messages</h2>
      <div class="section-line"></div>
    </div>
    <div class="msg-layout">
      <div class="msg-sidebar">
        <div class="conv-tabs">
          <button class="conv-tab active" id="tabGeneral" onclick="switchConv('general')">üåç G√©n√©ral</button>
          <button class="conv-tab" id="tabAdmin" onclick="switchConv('admin')">üîí Admin</button>
        </div>
        <div class="sidebar-label">üë• Membres</div>
        <div class="user-list" id="userList"></div>
      </div>
      <div class="msg-main">
        <div class="conv-header">
          <div><div class="conv-header-title" id="convTitle">üí¨ Canal G√©n√©ral</div><div class="conv-header-sub" id="convSub">Ouvert √† tous</div></div>
          <span class="lock-badge" id="convBadge">PUBLIC</span>
        </div>
        <div class="msg-list" id="msgList"><div class="msg-empty">Aucun message. Sois le premier ! üôè</div></div>
        <div class="msg-input-wrap">
          <div class="rec-indicator" id="recIndicator"><div class="rec-dot"></div><span class="rec-text">Enregistrement...</span><span class="rec-timer" id="recTimer">0:00</span></div>
          <div id="msgInputArea" style="display:none;">
            <div class="msg-input-row">
              <input class="msg-input" type="text" id="msgInput" placeholder="√âcris un message..." onkeydown="if(event.key==='Enter')sendMsg()"/>
              <button class="voice-btn" id="voiceBtn" onclick="toggleRec()" title="Message vocal">üéô</button>
              <button class="msg-send" onclick="sendMsg()" data-i18n="msg_send">Envoyer</button>
            </div>
          </div>
          <div id="guestNotice" class="login-notice">Connecte-toi pour participer. <span onclick="openModal('login')">Se connecter</span> ou <span onclick="openModal('signup')">S'inscrire</span></div>
          <div id="lockedNotice" class="locked-notice" style="display:none;">üîí Canal r√©serv√© aux administrateurs.</div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="components.js"></script><script src="auth.js"></script><script src="i18n.js"></script><script src="notifications.js"></script>
<script>
let curConv='general',mediaRecorder=null,audioChunks=[],isRec=false,recInt=null,recSecs=0;
const EMOJIS=['üëç','üß°','üî•','üôè'];

function switchConv(conv){curConv=conv;document.getElementById('tabGeneral').classList.toggle('active',conv==='general');document.getElementById('tabAdmin').classList.toggle('active',conv==='admin');const a=conv==='admin';document.getElementById('convTitle').textContent=a?'üîí Canal Admins':'üí¨ Canal G√©n√©ral';document.getElementById('convSub').textContent=a?'R√©serv√© aux administrateurs':'Ouvert √† tous les membres et l\'admin';document.getElementById('convBadge').textContent=a?'ADMIN ONLY':'PUBLIC';renderMsgs();updateInputUI();}

function updateInputUI(){const user=getSession(),isAdm=user&&user.role==='admin',adConv=curConv==='admin';document.getElementById('guestNotice').style.display=!user?'':'none';document.getElementById('lockedNotice').style.display=(user&&adConv&&!isAdm)?'':'none';document.getElementById('msgInputArea').style.display=(user&&(!adConv||isAdm))?'':'none';}

function sendMsg(){const user=getSession();if(!user)return;if(curConv==='admin'&&user.role!=='admin')return;const input=document.getElementById('msgInput');const text=input.value.trim();if(!text)return;const msgs=getMsgs();msgs.push({id:Date.now(),name:user.name,role:user.role,text,conv:curConv,type:'text',reactions:{},time:new Date().toLocaleTimeString('fr',{hour:'2-digit',minute:'2-digit'})});saveMsgs(msgs);input.value='';renderMsgs();}

async function toggleRec(){const user=getSession();if(!user)return;
  if(!isRec){
    try{const stream=await navigator.mediaDevices.getUserMedia({audio:true});mediaRecorder=new MediaRecorder(stream);audioChunks=[];mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    mediaRecorder.onstop=()=>{const blob=new Blob(audioChunks,{type:'audio/webm'});const r=new FileReader();r.onload=e=>{const msgs=getMsgs();msgs.push({id:Date.now(),name:user.name,role:user.role,audio:e.target.result,duration:recSecs,conv:curConv,type:'audio',reactions:{},time:new Date().toLocaleTimeString('fr',{hour:'2-digit',minute:'2-digit'})});saveMsgs(msgs);renderMsgs();};r.readAsDataURL(blob);stream.getTracks().forEach(t=>t.stop());};
    mediaRecorder.start();isRec=true;recSecs=0;document.getElementById('voiceBtn').classList.add('recording');document.getElementById('voiceBtn').textContent='‚èπ';document.getElementById('recIndicator').classList.add('active');
    recInt=setInterval(()=>{recSecs++;const m=Math.floor(recSecs/60),s=recSecs%60;document.getElementById('recTimer').textContent=m+':'+(s<10?'0':'')+s;},1000);
    toast('üéô Enregistrement d√©marr√©...');}catch(e){toast('‚ùå Autorise l\'acc√®s micro dans ton navigateur.');}
  }else{mediaRecorder.stop();isRec=false;clearInterval(recInt);document.getElementById('voiceBtn').classList.remove('recording');document.getElementById('voiceBtn').textContent='üéô';document.getElementById('recIndicator').classList.remove('active');document.getElementById('recTimer').textContent='0:00';toast('‚úÖ Message vocal envoy√© !');}}

function toggleReactPopup(id){const p=document.getElementById('rpop-'+id);if(!p)return;const open=p.classList.contains('show');document.querySelectorAll('.react-popup.show').forEach(x=>x.classList.remove('show'));if(!open)p.classList.add('show');}

function addReaction(id,emoji){const user=getSession();if(!user){openModal('login');return;}document.querySelectorAll('.react-popup.show').forEach(p=>p.classList.remove('show'));const msgs=getMsgs();const msg=msgs.find(m=>m.id===id);if(!msg)return;if(!msg.reactions)msg.reactions={};if(!msg.reactions[emoji])msg.reactions[emoji]=[];const i=msg.reactions[emoji].indexOf(user.name);if(i===-1)msg.reactions[emoji].push(user.name);else msg.reactions[emoji].splice(i,1);if(msg.reactions[emoji].length===0)delete msg.reactions[emoji];saveMsgs(msgs);renderMsgs();}

function renderMsgs(){
  const all=getMsgs().filter(m=>(m.conv||'general')===curConv);
  const list=document.getElementById('msgList');const user=getSession();
  list.innerHTML='';
  if(all.length===0){list.innerHTML='<div class="msg-empty">Aucun message. Sois le premier ! üôè</div>';return;}
  all.forEach(m=>{
    const isMe=user&&m.name===user.name,isAdm=m.role==='admin';
    const ini=m.name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
    const avClass=isAdm?'adm':'mem';
    const bubClass=isMe?'mine':(isAdm?'from-adm':'from-mem');
    const savedAv=localStorage.getItem('glory_avatar_'+getUsers().find(u=>u.name===m.name)?.email);
    const avContent=savedAv?`<img src="${savedAv}" alt=""/>`:(isAdm&&localStorage.getItem('glory_avatar_admin@glory.com'))?`<img src="${localStorage.getItem('glory_avatar_admin@glory.com')}" alt=""/>`:ini;
    let content='';
    if(m.type==='audio'&&m.audio){const ds=`${Math.floor((m.duration||0)/60)}:${String((m.duration||0)%60).padStart(2,'0')}`;content=`<div class="audio-msg"><button class="play-btn" onclick="playAudio(${m.id},this,'${m.audio}')">‚ñ∂</button><div class="audio-wave"><div class="audio-wave-bar" id="awb-${m.id}" style="width:0%"></div></div><span class="audio-dur" id="adt-${m.id}">${ds}</span><audio id="aud-${m.id}" src="${m.audio}" style="display:none" onended="resetAudio('${m.id}')"></audio></div>`;}
    else{content=m.text||'';}
    const reactions=m.reactions||{};
    const pills=Object.entries(reactions).filter(([,v])=>v.length>0).map(([e,us])=>{const mine=user&&us.includes(user.name);return`<span class="react-pill${mine?' mine-pill':''}" onclick="addReaction(${m.id},'${e}')">${e} <span class="rc">${us.length}</span></span>`;}).join('');
    const row=document.createElement('div');row.className='msg-row'+(isMe?' me':'');
    row.innerHTML=`<div class="m-av ${avClass}">${avContent}</div>
      <div class="msg-bwrap">
        <div class="msg-sender${isAdm?' adm-lbl':''}">${isAdm?'‚ú¶ ':''}${m.name}</div>
        <div class="msg-bubble ${bubClass}" style="position:relative;">${content}
          <div class="react-popup" id="rpop-${m.id}">${EMOJIS.map(e=>`<button onclick="addReaction(${m.id},'${e}')">${e}</button>`).join('')}</div>
        </div>
        <div class="msg-meta-row">
          <span class="msg-time">${m.time}</span>
          <button class="react-trigger" onclick="toggleReactPopup(${m.id})">+ üòä</button>
          ${pills?`<div class="react-pills">${pills}</div>`:''}
        </div>
      </div>`;
    list.appendChild(row);
  });
  list.scrollTop=list.scrollHeight;
}

function playAudio(id,btn,src){const audio=document.getElementById('aud-'+id);if(!audio)return;if(audio.paused){document.querySelectorAll('audio').forEach(a=>{if(a.id!=='aud-'+id){a.pause();resetAudio(a.id.replace('aud-',''));}});audio.play();btn.textContent='‚è∏';audio.ontimeupdate=()=>{const p=(audio.currentTime/audio.duration)*100||0;const b=document.getElementById('awb-'+id);const d=document.getElementById('adt-'+id);if(b)b.style.width=p+'%';if(d){const r=Math.max(0,Math.floor(audio.duration-audio.currentTime));d.textContent=Math.floor(r/60)+':'+String(r%60).padStart(2,'0');}};}else{audio.pause();btn.textContent='‚ñ∂';}}
function resetAudio(id){const btn=document.querySelector(`#aud-${id}`)?.closest('.audio-msg')?.querySelector('.play-btn');if(btn)btn.textContent='‚ñ∂';const b=document.getElementById('awb-'+id);if(b)b.style.width='0%';}

function renderUserList(){
  const ul=document.getElementById('userList');const users=getUsers();const user=getSession();
  const adminAv=localStorage.getItem('glory_avatar_admin@glory.com');
  ul.innerHTML=`<div class="user-item"><div class="u-av adm">${adminAv?`<img src="${adminAv}" alt=""/>`:' AG'}</div><div><div class="u-name">Admin Glory</div><div class="u-role">‚ú¶ Admin</div></div></div>`;
  if(users.length===0){ul.innerHTML+='<div style="color:rgba(184,168,122,.3);font-size:.78rem;padding:.5rem;">Aucun membre encore.</div>';return;}
  users.forEach(u=>{const ini=u.name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();const av=localStorage.getItem('glory_avatar_'+u.email);ul.innerHTML+=`<div class="user-item"><div class="u-av mem">${av?`<img src="${av}" alt=""/>`:ini}</div><div><div class="u-name">${u.name}</div><div class="u-country">${u.country||''}</div></div></div>`;});
}

document.addEventListener('click',e=>{if(!e.target.closest('.react-trigger')&&!e.target.closest('.react-popup'))document.querySelectorAll('.react-popup.show').forEach(p=>p.classList.remove('show'));});
window.addEventListener('DOMContentLoaded',()=>{renderUserList();renderMsgs();updateInputUI();});
</script>
</body></html>
