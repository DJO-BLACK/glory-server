<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GLORY ‚Äì Accueil</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#D4AF37"/>
  <style>
    .hero{position:relative;min-height:100vh;display:flex;align-items:center;justify-content:center;text-align:center;overflow:hidden;}
    .hero-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 30%,rgba(212,175,55,.15) 0%,transparent 60%),linear-gradient(180deg,#0a0800,#1a1200 50%,#0a0800);}
    .hero-img{position:absolute;inset:0;background-image:url('https://images.unsplash.com/photo-1519491050282-cf00c82424b3?w=1600&q=80');background-size:cover;background-position:center;opacity:.15;}
    .hero-content{position:relative;z-index:2;max-width:900px;padding:2rem;animation:heroIn 1.2s ease forwards;}
    @keyframes heroIn{from{opacity:0;transform:translateY(40px);}to{opacity:1;transform:translateY(0);}}
    .hero-cross{font-size:3rem;color:var(--gold);margin-bottom:1rem;animation:glow 3s ease-in-out infinite;}
    @keyframes glow{0%,100%{text-shadow:0 0 20px rgba(212,175,55,.5);}50%{text-shadow:0 0 60px rgba(212,175,55,1);}}
    .hero-content h1{font-family:'Cinzel Decorative',cursive;font-size:clamp(3rem,10vw,7rem);color:var(--gold);letter-spacing:8px;}
    .hero-content h2{font-family:'Playfair Display',serif;font-style:italic;font-size:clamp(1rem,2.5vw,1.4rem);color:var(--white);margin-top:.8rem;letter-spacing:3px;font-weight:300;}
    .hero-divider{width:80px;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:1.5rem auto;}
    .hero-desc{color:var(--text-muted);margin:0 auto 2rem;max-width:580px;line-height:1.9;}
    .btn-cta{display:inline-block;background:linear-gradient(135deg,var(--gold-dark),var(--gold),var(--gold-light));color:var(--bg-dark);font-weight:700;font-size:.9rem;letter-spacing:3px;text-transform:uppercase;padding:1rem 2.5rem;border:none;cursor:pointer;transition:all .3s;}
    .btn-cta:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(212,175,55,.5);}
    .admin-form-box{background:rgba(212,175,55,.04);border:1px solid rgba(212,175,55,.2);border-radius:8px;padding:2rem;margin-bottom:2rem;display:none;}
    .admin-form-box h3{font-family:'Cinzel Decorative',cursive;color:var(--gold);font-size:1rem;margin-bottom:1.5rem;}
    .post-type-tabs{display:flex;gap:.5rem;margin-bottom:1.2rem;flex-wrap:wrap;}
    .post-type-tab{padding:.5rem 1.1rem;border-radius:4px;cursor:pointer;font-size:.8rem;font-weight:700;border:1px solid rgba(212,175,55,.3);color:var(--text-muted);background:none;transition:all .3s;}
    .post-type-tab.active{background:var(--gold);color:var(--bg-dark);border-color:var(--gold);}
    .upload-area{border:2px dashed rgba(212,175,55,.3);border-radius:6px;padding:2rem;text-align:center;cursor:pointer;transition:all .3s;}
    .upload-area:hover{border-color:var(--gold);}
    .upload-icon{font-size:2rem;margin-bottom:.5rem;}
    .upload-area p{color:var(--text-muted);font-size:.85rem;}
    .media-preview-img,.media-preview-vid{max-width:100%;max-height:200px;border-radius:6px;margin-top:.5rem;display:none;}
    .feed-wrap{max-width:680px;margin:0 auto;display:flex;flex-direction:column;gap:1.5rem;}
    .post-card{background:rgba(255,255,255,.03);border:1px solid rgba(212,175,55,.15);border-radius:10px;overflow:hidden;transition:border-color .3s;}
    .post-card:hover{border-color:rgba(212,175,55,.35);}
    .post-header{display:flex;align-items:center;gap:.8rem;padding:1rem 1.2rem .7rem;}
    .post-avatar{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#ff9800,#ffcc02);display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:700;color:var(--bg-dark);flex-shrink:0;overflow:hidden;}
    .post-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
    .post-author{font-size:.88rem;color:var(--white);font-weight:700;}
    .post-date{font-size:.7rem;color:rgba(184,168,122,.5);}
    .post-type-label{margin-left:auto;font-size:.62rem;letter-spacing:1px;text-transform:uppercase;color:var(--gold);background:rgba(212,175,55,.1);border:1px solid rgba(212,175,55,.2);padding:.2rem .6rem;border-radius:3px;}
    .post-media{background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden;max-height:480px;}
    .post-media img{width:100%;height:auto;max-height:480px;object-fit:contain;display:block;background:#000;}
    .post-media video{width:100%;max-height:480px;display:block;background:#000;}
    .post-text{padding:1rem 1.2rem;color:var(--white);font-size:.92rem;line-height:1.75;}
    .post-actions{display:flex;gap:1rem;padding:.7rem 1.2rem;border-top:1px solid rgba(255,255,255,.05);align-items:center;}
    .action-btn{display:flex;align-items:center;gap:.4rem;background:none;border:none;color:var(--text-muted);font-size:.85rem;cursor:pointer;padding:.3rem .7rem;border-radius:6px;transition:all .3s;}
    .action-btn:hover{background:rgba(255,255,255,.05);color:var(--white);}
    .action-btn.liked{color:#e53e3e;}
    .delete-post-btn{margin-left:auto;background:none;border:none;color:rgba(229,62,62,.4);cursor:pointer;font-size:.85rem;transition:color .2s;display:none;}
    .delete-post-btn.visible{display:block;}
    .delete-post-btn:hover{color:#e53e3e;}
    .comments-section{border-top:1px solid rgba(255,255,255,.05);padding:.8rem 1.2rem;display:none;}
    .comments-section.open{display:block;}
    .comment-item{display:flex;gap:.6rem;margin-bottom:.7rem;align-items:flex-start;}
    .comment-av{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dark),var(--gold));display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;color:var(--bg-dark);flex-shrink:0;}
    .comment-av.adm{background:linear-gradient(135deg,#ff9800,#ffcc02);}
    .comment-bubble{background:rgba(255,255,255,.04);border-radius:6px;padding:.5rem .8rem;flex:1;}
    .comment-name{font-size:.7rem;color:var(--gold);font-weight:700;margin-bottom:.15rem;}
    .comment-name.adm{color:#ff9800;}
    .comment-text{font-size:.83rem;color:var(--white);line-height:1.5;}
    .comment-input-row{display:flex;gap:.5rem;margin-top:.7rem;}
    .comment-input{flex:1;background:rgba(0,0,0,.4);border:1px solid rgba(212,175,55,.2);color:var(--white);padding:.5rem .8rem;border-radius:4px;font-size:.83rem;font-family:'Lato',sans-serif;outline:none;}
    .comment-input:focus{border-color:var(--gold);}
    .comment-send{background:var(--gold);color:var(--bg-dark);border:none;padding:.5rem 1rem;border-radius:4px;font-weight:700;font-size:.78rem;cursor:pointer;}
    .login-interact{font-size:.78rem;color:var(--text-muted);text-align:center;padding:.5rem;}
    .login-interact span{color:var(--gold);cursor:pointer;}
    .empty-feed{text-align:center;padding:4rem 2rem;color:var(--text-muted);}
    .loading-feed{text-align:center;padding:3rem;color:var(--text-muted);}
    .spinner{width:32px;height:32px;border:3px solid rgba(212,175,55,.2);border-top:3px solid var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem;}
    @keyframes spin{to{transform:rotate(360deg);}}
  </style>
</head>
<body>
<div class="page-content" style="padding-top:0;">
  <div class="hero">
    <div class="hero-bg"></div><div class="hero-img"></div>
    <div class="hero-content">
      <div class="hero-cross">‚úû</div>
      <h1>GLORY</h1>
      <h2>R√©unis dans Sa Pr√©sence</h2>
      <div class="hero-divider"></div>
      <p class="hero-desc">Une communaut√© mondiale pour adorer et parler du seul vrai DIEU.</p>
      <button class="btn-cta" onclick="openModal('signup')">Rejoindre la Communaut√©</button>
    </div>
  </div>

  <div class="section-wrap">
    <div class="section-header">
      <span class="section-tag">‚ú¶ Publications ‚ú¶</span>
      <h2 class="section-title">La Parole du Jour</h2>
      <div class="section-line"></div>
    </div>

    <!-- Formulaire admin -->
    <div class="admin-form-box admin-only" id="adminPostForm">
      <h3>‚ûï Cr√©er un Post</h3>
      <div class="post-type-tabs">
        <button class="post-type-tab active" onclick="switchPostType('texte',this)">üìù Texte</button>
        <button class="post-type-tab" onclick="switchPostType('photo',this)">üì∑ Photo</button>
        <button class="post-type-tab" onclick="switchPostType('video',this)">üé• Vid√©o</button>
      </div>
      <div class="form-group">
        <label>Cat√©gorie</label>
        <select id="postCategory">
          <option>Message</option><option>Pri√®re</option><option>T√©moignage</option>
          <option>Annonce</option><option>Verset</option><option>Louange</option>
        </select>
      </div>
      <div class="form-group">
        <label>Titre</label>
        <input type="text" id="postTitle" placeholder="Titre de ton post..."/>
      </div>
      <div class="form-group">
        <label>Contenu</label>
        <textarea id="postContent" rows="4" placeholder="Partage un message, une pri√®re, un verset..."></textarea>
      </div>
      <div id="mediaUploadArea" style="display:none;">
        <div class="upload-area" onclick="document.getElementById('mediaFile').click()">
          <div class="upload-icon">üìÅ</div>
          <p id="uploadLabel">Clique pour choisir une photo</p>
        </div>
        <input type="file" id="mediaFile" style="display:none;" onchange="previewMedia(this)"/>
        <img class="media-preview-img" id="imgPreview"/>
        <video class="media-preview-vid" id="vidPreview" controls></video>
      </div>
      <button class="btn-submit" style="margin-top:1rem;" onclick="submitPost()">Publier ‚ú¶</button>
    </div>

    <!-- Feed -->
    <div class="feed-wrap" id="feedWrap">
      <div class="loading-feed"><div class="spinner"></div><p>Chargement des publications...</p></div>
    </div>
  </div>
</div>

<script src="https://glory-server-production.up.railway.app/socket.io/socket.io.js"></script>
<script src="components.js"></script>
<script src="api.js"></script>
<script src="i18n.js"></script>
<script src="notifications.js"></script>
<script>
const API_URL = 'https://glory-server-production.up.railway.app';
const socket  = io(API_URL, { transports: ['websocket','polling'] });

let currentPostType = 'texte';
let allPosts = [];

// ‚ïê‚ïê Type de post ‚ïê‚ïê
function switchPostType(type, btn) {
  currentPostType = type;
  document.querySelectorAll('.post-type-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const mediaArea = document.getElementById('mediaUploadArea');
  const label     = document.getElementById('uploadLabel');
  mediaArea.style.display = type === 'texte' ? 'none' : 'block';
  label.textContent = type === 'photo' ? 'Clique pour choisir une photo' : 'Clique pour choisir une vid√©o';
  document.getElementById('mediaFile').accept = type === 'photo' ? 'image/*' : 'video/*';
  document.getElementById('imgPreview').style.display = 'none';
  document.getElementById('vidPreview').style.display = 'none';
}

function previewMedia(input) {
  const file = input.files[0]; if (!file) return;
  const img  = document.getElementById('imgPreview');
  const vid  = document.getElementById('vidPreview');
  const url  = URL.createObjectURL(file);
  if (currentPostType === 'photo') { img.src = url; img.style.display = 'block'; vid.style.display = 'none'; }
  else { vid.src = url; vid.style.display = 'block'; img.style.display = 'none'; }
}

// ‚ïê‚ïê Cr√©er un post ‚ïê‚ïê
async function submitPost() {
  const user = getSession(); if (!user) { openModal('login'); return; }
  const title   = document.getElementById('postTitle').value.trim();
  const content = document.getElementById('postContent').value.trim();
  const type    = document.getElementById('postCategory').value;
  if (!content && !title) { toast('Ajoute un titre ou du contenu.'); return; }

  try {
    let mediaUrl = '', mediaType = '';
    const file = document.getElementById('mediaFile').files[0];
    if (file && currentPostType !== 'texte') {
      const fd = new FormData(); fd.append('media', file);
      const res = await fetch(API_URL + '/api/posts/media', {
        method: 'POST', headers: { 'Authorization': 'Bearer ' + getToken() }, body: fd
      });
      const data = await res.json();
      mediaUrl  = API_URL + data.url;
      mediaType = currentPostType;
    }

    const post = await apiCall('POST', '/api/posts', { type, postType: currentPostType, title, content, mediaUrl, mediaType }, true);
    document.getElementById('postTitle').value   = '';
    document.getElementById('postContent').value = '';
    document.getElementById('mediaFile').value   = '';
    document.getElementById('imgPreview').style.display = 'none';
    document.getElementById('vidPreview').style.display = 'none';
    toast('‚úÖ Post publi√© !');
    // Le post sera ajout√© via Socket.io
  } catch(e) { toast('‚ùå ' + e.message); }
}

// ‚ïê‚ïê Charger les posts ‚ïê‚ïê
async function fetchPosts() {
  try {
    allPosts = await loadPosts();
    renderFeed(allPosts);
  } catch(e) {
    document.getElementById('feedWrap').innerHTML = '<div class="empty-feed">‚ùå Impossible de charger les publications.</div>';
  }
}

function renderFeed(posts) {
  const user = getSession();
  const isAdmin = user && (user.role === 'admin' || user.role === 'subadmin');
  const wrap = document.getElementById('feedWrap');
  if (!posts || posts.length === 0) {
    wrap.innerHTML = '<div class="empty-feed">Aucune publication pour le moment. Sois le premier √† partager ! üôè</div>';
    return;
  }
  wrap.innerHTML = posts.map(p => {
    const author = p.author || {};
    const ini    = (author.name||'?').split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
    const isAdm  = author.role === 'admin' || author.role === 'subadmin';
    const date   = new Date(p.createdAt).toLocaleDateString('fr');
    const liked  = user && p.likes && p.likes.includes(user.id);
    const mediaHtml = p.mediaUrl
      ? (p.postType === 'photo'
          ? `<div class="post-media"><img src="${p.mediaUrl}" alt=""/></div>`
          : `<div class="post-media"><video src="${p.mediaUrl}" controls></video></div>`)
      : '';
    const commentsHtml = (p.comments||[]).map(c => {
      const ci = (c.name||'?').split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
      const ca = c.role === 'admin' || c.role === 'subadmin';
      return `<div class="comment-item">
        <div class="comment-av ${ca?'adm':''}">${ci}</div>
        <div class="comment-bubble">
          <div class="comment-name ${ca?'adm':''}">${ca?'‚ú¶ ':''}${c.name}</div>
          <div class="comment-text">${c.text}</div>
        </div>
      </div>`;
    }).join('');

    return `<div class="post-card" id="post-${p._id}">
      <div class="post-header">
        <div class="post-avatar" style="${isAdm?'background:linear-gradient(135deg,#ff9800,#ffcc02)':''}">
          ${author.avatar ? `<img src="${author.avatar}" alt=""/>` : ini}
        </div>
        <div>
          <div class="post-author">${isAdm?'‚ú¶ ':''}${author.name||'Membre'}</div>
          <div class="post-date">${date}</div>
        </div>
        <span class="post-type-label">${p.type||'Message'}</span>
        ${isAdmin ? `<button class="delete-post-btn visible" onclick="removePost('${p._id}')">üóë Supprimer</button>` : ''}
      </div>
      ${mediaHtml}
      ${p.title ? `<div class="post-text"><strong>${p.title}</strong><br>${p.content||''}</div>` : (p.content ? `<div class="post-text">${p.content}</div>` : '')}
      <div class="post-actions">
        <button class="action-btn ${liked?'liked':''}" id="like-${p._id}" onclick="toggleLike('${p._id}')">
          ${liked?'‚ù§Ô∏è':'ü§ç'} <span id="likeCount-${p._id}">${(p.likes||[]).length}</span> J'aime
        </button>
        <button class="action-btn" onclick="toggleComments('${p._id}')">
          üí¨ <span>${(p.comments||[]).length}</span> Commentaires
        </button>
      </div>
      <div class="comments-section" id="comments-${p._id}">
        <div id="cmtList-${p._id}">${commentsHtml}</div>
        ${user
          ? `<div class="comment-input-row">
               <input class="comment-input" type="text" id="cmtInput-${p._id}" placeholder="Ajoute un commentaire..." onkeydown="if(event.key==='Enter')addComment('${p._id}')"/>
               <button class="comment-send" onclick="addComment('${p._id}')">‚Üë</button>
             </div>`
          : `<div class="login-interact"><span onclick="openModal('login')">Connecte-toi</span> pour commenter</div>`
        }
      </div>
    </div>`;
  }).join('');
}

function toggleComments(id) {
  document.getElementById('comments-' + id).classList.toggle('open');
}

async function toggleLike(id) {
  const user = getSession(); if (!user) { openModal('login'); return; }
  try {
    const data = await likePost(id);
    const liked = data.likes.includes(user.id);
    const btn   = document.getElementById('like-' + id);
    if (btn) {
      btn.className = 'action-btn' + (liked ? ' liked' : '');
      btn.innerHTML = `${liked?'‚ù§Ô∏è':'ü§ç'} <span id="likeCount-${id}">${data.likes.length}</span> J'aime`;
    }
  } catch(e) { toast('‚ùå ' + e.message); }
}

async function addComment(id) {
  const user = getSession(); if (!user) { openModal('login'); return; }
  const input = document.getElementById('cmtInput-' + id);
  const text  = input.value.trim(); if (!text) return;
  try {
    await commentPost(id, text);
    input.value = '';
  } catch(e) { toast('‚ùå ' + e.message); }
}

async function removePost(id) {
  if (!confirm('Supprimer ce post ?')) return;
  try { await deletePost(id); } catch(e) { toast('‚ùå ' + e.message); }
}

// ‚ïê‚ïê Socket.io ‚Äî Temps r√©el ‚ïê‚ïê
socket.on('new_post', post => {
  allPosts.unshift(post);
  renderFeed(allPosts);
});

socket.on('delete_post', id => {
  allPosts = allPosts.filter(p => p._id !== id);
  renderFeed(allPosts);
});

socket.on('update_likes', ({ postId, likes }) => {
  const p = allPosts.find(x => x._id === postId);
  if (p) p.likes = likes;
  const user  = getSession();
  const liked = user && likes.includes(user.id);
  const btn   = document.getElementById('like-' + postId);
  if (btn) {
    btn.className = 'action-btn' + (liked ? ' liked' : '');
    btn.innerHTML = `${liked?'‚ù§Ô∏è':'ü§ç'} <span>${likes.length}</span> J'aime`;
  }
});

socket.on('new_comment', ({ postId, comment }) => {
  const p = allPosts.find(x => x._id === postId);
  if (p) { if (!p.comments) p.comments = []; p.comments.push(comment); }
  const list = document.getElementById('cmtList-' + postId);
  if (list) {
    const ci = (comment.name||'?').split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
    const ca = comment.role === 'admin';
    list.innerHTML += `<div class="comment-item">
      <div class="comment-av ${ca?'adm':''}">${ci}</div>
      <div class="comment-bubble">
        <div class="comment-name ${ca?'adm':''}">${ca?'‚ú¶ ':''}${comment.name}</div>
        <div class="comment-text">${comment.text}</div>
      </div>
    </div>`;
  }
});

// Afficher le formulaire admin
function onLoginSuccess() {
  fetchPosts();
  const user = getSession();
  if (user && (user.role === 'admin' || user.role === 'subadmin')) {
    document.getElementById('adminPostForm').style.display = 'block';
  }
}

window.addEventListener('DOMContentLoaded', () => {
  fetchPosts();
  const user = getSession();
  if (user && (user.role === 'admin' || user.role === 'subadmin')) {
    document.getElementById('adminPostForm').style.display = 'block';
  }
});
</script>
</body>
</html>
