<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GLORY ‚Äì √âv√©nements</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="manifest" href="manifest.json"/>
  <style>
    .evt-admin-form { background:rgba(212,175,55,0.04); border:1px solid rgba(212,175,55,0.2); border-radius:8px; padding:2rem; margin-bottom:2.5rem; display:none; }
    .evt-admin-form h3 { font-family:'Cinzel Decorative',cursive; color:var(--gold); font-size:1rem; margin-bottom:1.5rem; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }

    .evt-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:1.5rem; }
    .evt-card { background:rgba(255,255,255,0.02); border:1px solid rgba(212,175,55,0.15); border-radius:8px; overflow:hidden; transition:all .3s; position:relative; }
    .evt-card:hover { transform:translateY(-4px); border-color:rgba(212,175,55,0.4); box-shadow:0 8px 30px rgba(212,175,55,0.1); }
    .evt-card-top { background:linear-gradient(135deg,rgba(212,175,55,0.12),rgba(168,134,12,0.08)); padding:1.5rem; border-bottom:1px solid rgba(212,175,55,0.12); }
    .evt-type-badge { font-size:.62rem; letter-spacing:2px; text-transform:uppercase; color:var(--gold); background:rgba(212,175,55,0.12); border:1px solid rgba(212,175,55,0.2); padding:.2rem .6rem; border-radius:3px; display:inline-block; margin-bottom:.7rem; }
    .evt-title { font-family:'Playfair Display',serif; color:var(--white); font-size:1.15rem; margin-bottom:.5rem; }
    .evt-date-row { display:flex; align-items:center; gap:.5rem; color:var(--gold); font-size:.82rem; font-weight:700; }
    .evt-body { padding:1.2rem; }
    .evt-desc { color:var(--text-muted); font-size:.85rem; line-height:1.7; margin-bottom:.8rem; }
    .evt-meta { display:flex; gap:1rem; font-size:.75rem; color:rgba(184,168,122,0.5); }
    .evt-participants { font-size:.75rem; color:var(--text-muted); display:flex; align-items:center; gap:.4rem; margin-top:.7rem; }
    .btn-join { background:linear-gradient(135deg,var(--gold-dark),var(--gold)); color:var(--bg-dark); border:none; padding:.55rem 1.2rem; border-radius:4px; font-weight:700; font-size:.78rem; cursor:pointer; transition:all .3s; letter-spacing:1px; }
    .btn-join:hover { filter:brightness(1.1); }
    .btn-join.joined { background:rgba(212,175,55,0.15); color:var(--gold); border:1px solid var(--gold); }
    .evt-delete { position:absolute; top:.8rem; right:.8rem; background:rgba(229,62,62,0.1); border:1px solid rgba(229,62,62,0.3); color:#fc8181; width:26px; height:26px; border-radius:50%; cursor:pointer; font-size:.85rem; display:none; align-items:center; justify-content:center; }
    .evt-delete.visible { display:flex; }
    .evt-empty { text-align:center; padding:4rem 2rem; color:var(--text-muted); }

    /* Calendrier mini */
    .calendar-wrap { background:rgba(255,255,255,0.02); border:1px solid rgba(212,175,55,0.12); border-radius:8px; padding:1.5rem; margin-bottom:2rem; max-width:400px; margin-left:auto; margin-right:auto; }
    .cal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .cal-month { font-family:'Cinzel Decorative',cursive; color:var(--gold); font-size:.9rem; }
    .cal-nav { background:none; border:1px solid rgba(212,175,55,0.2); color:var(--gold); width:28px; height:28px; border-radius:50%; cursor:pointer; font-size:.9rem; transition:all .3s; }
    .cal-nav:hover { background:rgba(212,175,55,0.1); }
    .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; text-align:center; }
    .cal-day-name { font-size:.65rem; color:rgba(184,168,122,0.5); padding:.3rem 0; text-transform:uppercase; letter-spacing:1px; }
    .cal-day { font-size:.8rem; color:var(--text-muted); padding:.4rem; border-radius:4px; cursor:default; }
    .cal-day.has-event { background:rgba(212,175,55,0.2); color:var(--gold); font-weight:700; cursor:pointer; border:1px solid rgba(212,175,55,0.3); }
    .cal-day.has-event:hover { background:rgba(212,175,55,0.35); }
    .cal-day.today { border:1px solid rgba(212,175,55,0.4); color:var(--white); }
    .cal-day.empty { opacity:0; }

    @media(max-width:640px) { .form-row{grid-template-columns:1fr;} }
  </style>
</head>
<body>
<div class="page-content">
  <div class="section-wrap">
    <div class="section-header">
      <span class="section-tag" data-i18n="evt_tag">‚ú¶ Agenda ‚ú¶</span>
      <h2 class="section-title" data-i18n="evt_title">Calendrier d'√âv√©nements</h2>
      <div class="section-line"></div>
    </div>

    <!-- Formulaire Admin -->
    <div class="evt-admin-form" id="evtAdminForm">
      <h3>üìÖ Cr√©er un √âv√©nement</h3>
      <div class="form-group">
        <label>Type d'√©v√©nement</label>
        <select id="evtType">
          <option>Culte</option><option>Pri√®re</option><option>Je√ªne</option>
          <option>Retraite Spirituelle</option><option>Conf√©rence</option>
          <option>√âtude Biblique</option><option>Worship Night</option><option>Autre</option>
        </select>
      </div>
      <div class="form-group"><label>Titre</label><input type="text" id="evtTitle" placeholder="Titre de l'√©v√©nement..."/></div>
      <div class="form-row">
        <div class="form-group"><label>Date</label><input type="date" id="evtDate"/></div>
        <div class="form-group"><label>Heure</label><input type="time" id="evtTime"/></div>
      </div>
      <div class="form-group"><label>Lieu / Plateforme</label><input type="text" id="evtLieu" placeholder="En ligne, √âglise XYZ, YouTube..."/></div>
      <div class="form-group"><label>Description</label><textarea id="evtDesc" rows="3" placeholder="D√©cris l'√©v√©nement..."></textarea></div>
      <button class="btn-submit" onclick="createEvent()">Publier l'√âv√©nement</button>
    </div>

    <!-- Calendrier -->
    <div class="calendar-wrap" id="calWrap"></div>

    <!-- √âv√©nements -->
    <div class="evt-grid" id="evtGrid"></div>
    <div class="evt-empty" id="evtEmpty">
      <div style="font-size:3rem;margin-bottom:1rem;">üìÖ</div>
      <p>Aucun √©v√©nement programm√© pour le moment.</p>
      <p style="font-size:.82rem;margin-top:.4rem;opacity:.5;">L'admin publiera bient√¥t les prochains √©v√©nements.</p>
    </div>
  </div>
</div>

<script src="components.js"></script>
<script src="auth.js"></script>
<script src="i18n.js"></script>
<script src="notifications.js"></script>
<script>
  const getEvents = () => JSON.parse(localStorage.getItem('glory_events')||'[]');
  const saveEvents = d => localStorage.setItem('glory_events', JSON.stringify(d));
  let calDate = new Date();

  function createEvent() {
    const type  = document.getElementById('evtType').value;
    const title = document.getElementById('evtTitle').value.trim();
    const date  = document.getElementById('evtDate').value;
    const time  = document.getElementById('evtTime').value;
    const lieu  = document.getElementById('evtLieu').value.trim();
    const desc  = document.getElementById('evtDesc').value.trim();
    if (!title||!date) { toast('Titre et date requis.'); return; }
    const events = getEvents();
    events.push({ id:Date.now(), type, title, date, time, lieu, desc, participants:[] });
    events.sort((a,b)=>a.date.localeCompare(b.date));
    saveEvents(events);
    ['evtTitle','evtDate','evtTime','evtLieu','evtDesc'].forEach(id=>document.getElementById(id).value='');
    renderEvents();
    renderCalendar();
    createNotif('event','Nouvel √âv√©nement : '+title, date+(time?' √† '+time:'')+(lieu?' ‚Äî '+lieu:''), 'evenements.html');
    toast('‚úÖ √âv√©nement publi√© !');
  }

  function joinEvent(id) {
    const user = getSession();
    if (!user) { openModal('login'); return; }
    const events = getEvents();
    const evt    = events.find(e=>e.id===id);
    if (!evt) return;
    const idx = evt.participants.indexOf(user.name);
    if (idx===-1) evt.participants.push(user.name);
    else evt.participants.splice(idx,1);
    saveEvents(events);
    renderEvents();
    toast(idx===-1 ? '‚úÖ Tu participes √† cet √©v√©nement !' : 'Tu t\'es retir√© de cet √©v√©nement.');
  }

  function deleteEvent(id) {
    if (!confirm('Supprimer cet √©v√©nement ?')) return;
    saveEvents(getEvents().filter(e=>e.id!==id));
    renderEvents(); renderCalendar();
    toast('√âv√©nement supprim√©.');
  }

  const typeEmoji = { Culte:'‚õ™',Pri√®re:'üôè',Je√ªne:'‚ú®','Retraite Spirituelle':'üåÑ','Conf√©rence':'üé§','√âtude Biblique':'üìñ','Worship Night':'üéµ',Autre:'üìÖ' };

  function renderEvents() {
    const events = getEvents();
    const grid   = document.getElementById('evtGrid');
    const empty  = document.getElementById('evtEmpty');
    const user   = getSession();
    const isAdmin = user && user.role==='admin';
    grid.innerHTML='';
    if (events.length===0) { empty.style.display='block'; return; }
    empty.style.display='none';
    const now = new Date().toISOString().split('T')[0];
    events.forEach(e => {
      const joined  = user && e.participants.includes(user.name);
      const isPast  = e.date < now;
      const emoji   = typeEmoji[e.type]||'üìÖ';
      const dateStr = e.date ? new Date(e.date+'T12:00:00').toLocaleDateString('fr',{weekday:'long',day:'numeric',month:'long',year:'numeric'}) : '';
      const card = document.createElement('div');
      card.className = 'evt-card';
      if (isPast) card.style.opacity='.6';
      card.innerHTML = `
        <button class="evt-delete${isAdmin?' visible':''}" onclick="deleteEvent(${e.id})">√ó</button>
        <div class="evt-card-top">
          <span class="evt-type-badge">${emoji} ${e.type}</span>
          <div class="evt-title">${e.title}</div>
          <div class="evt-date-row">üìÖ ${dateStr}${e.time?' ‚Äì '+e.time:''}</div>
        </div>
        <div class="evt-body">
          ${e.desc?`<div class="evt-desc">${e.desc}</div>`:''}
          ${e.lieu?`<div class="evt-meta">üìç ${e.lieu}</div>`:''}
          <div class="evt-participants">üë• ${e.participants.length} participant(s)</div>
          ${!isPast?`<div style="margin-top:.8rem;"><button class="btn-join${joined?' joined':''}" onclick="joinEvent(${e.id})">${joined?'‚úì Inscrit':'Participer'}</button></div>`:'<div style="margin-top:.8rem;font-size:.75rem;color:rgba(184,168,122,0.4);">√âv√©nement pass√©</div>'}
        </div>`;
      grid.appendChild(card);
    });
  }

  function renderCalendar() {
    const wrap = document.getElementById('calWrap');
    const events = getEvents();
    const eventDays = new Set(events.map(e=>e.date));
    const year  = calDate.getFullYear();
    const month = calDate.getMonth();
    const today = new Date();
    const firstDay = new Date(year,month,1).getDay();
    const daysInMonth = new Date(year,month+1,0).getDate();
    const monthNames = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
    const dayNames = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
    let html = `<div class="cal-header">
      <button class="cal-nav" onclick="changeMonth(-1)">‚Äπ</button>
      <span class="cal-month">${monthNames[month]} ${year}</span>
      <button class="cal-nav" onclick="changeMonth(1)">‚Ä∫</button>
    </div><div class="cal-grid">`;
    dayNames.forEach(d=>html+=`<div class="cal-day-name">${d}</div>`);
    for(let i=0;i<firstDay;i++) html+=`<div class="cal-day empty"></div>`;
    for(let d=1;d<=daysInMonth;d++){
      const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const isToday = today.getDate()===d && today.getMonth()===month && today.getFullYear()===year;
      const hasEvt  = eventDays.has(dateStr);
      html+=`<div class="cal-day${hasEvt?' has-event':''}${isToday?' today':''}"${hasEvt?` onclick="scrollToDate('${dateStr}')" title="√âv√©nement ce jour"`:''}>${d}</div>`;
    }
    html+='</div>';
    wrap.innerHTML = html;
  }

  function changeMonth(dir) { calDate.setMonth(calDate.getMonth()+dir); renderCalendar(); }
  function scrollToDate(date) {
    const card = Array.from(document.querySelectorAll('.evt-card')).find(c=>c.innerHTML.includes(date));
    if (card) card.scrollIntoView({behavior:'smooth',block:'center'});
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    const user = getSession();
    if (user && user.role==='admin') document.getElementById('evtAdminForm').style.display='block';
    // Date min = aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('evtDate');
    if(dateInput) dateInput.min = today;
    renderEvents();
    renderCalendar();
  });
</script>
</body>
</html>
